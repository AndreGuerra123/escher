/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * vkBeautify - javascript plugin to pretty-print or minify text in XML, JSON, CSS and SQL formats.
 *
 * Version - 0.99.00.beta
 * Copyright (c) 2012 Vadim Kiryukhin
 * vkiryukhin @ gmail.com
 * http://www.eslinstructor.net/vkbeautify/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 *   Pretty print
 *
 *        vkbeautify.xml(text [,indent_pattern]);
 *        vkbeautify.json(text [,indent_pattern]);
 *        vkbeautify.css(text [,indent_pattern]);
 *        vkbeautify.sql(text [,indent_pattern]);
 *
 *        @text - String; text to beatufy;
 *        @indent_pattern - Integer | String;
 *                Integer:  number of white spaces;
 *                String:   character string to visualize indentation ( can also be a set of white spaces )
 *   Minify
 *
 *        vkbeautify.xmlmin(text [,preserve_comments]);
 *        vkbeautify.jsonmin(text);
 *        vkbeautify.cssmin(text [,preserve_comments]);
 *        vkbeautify.sqlmin(text);
 *
 *        @text - String; text to minify;
 *        @preserve_comments - Bool; [optional];
 *                Set this flag to true to prevent removing comments from @text ( minxml and mincss functions only. )
 *
 *   Examples:
 *        vkbeautify.xml(text); // pretty print XML
 *        vkbeautify.json(text, 4 ); // pretty print JSON
 *        vkbeautify.css(text, '. . . .'); // pretty print CSS
 *        vkbeautify.sql(text, '----'); // pretty print SQL
 *
 *        vkbeautify.xmlmin(text, true);// minify XML, preserve comments
 *        vkbeautify.jsonmin(text);// minify JSON
 *        vkbeautify.cssmin(text);// minify CSS, remove comments ( default )
 *        vkbeautify.sqlmin(text);// minify SQL
 *
 */

/**
 * complete.ly 1.0.0
 * MIT Licensing
 * Copyright (c) 2013 Lorenzo Puccetti
 * 
 * This Software shall be used for doing good things, not bad things.
 * 
**/

(function(e,t){typeof define=="function"&&define.amd?define(t):e.escher=t()})(this,function(){var e,t,n;return function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("lib/d3",[],function(){return window.d3===undefined&&console.error("d3 is not loaded."),window.d3}),n("lib/vkbeautify",[],function(){function e(e){var t="    ";if(isNaN(parseInt(e)))t=e;else switch(e){case 1:t=" ";break;case 2:t="  ";break;case 3:t="   ";break;case 4:t="    ";break;case 5:t="     ";break;case 6:t="      ";break;case 7:t="       ";break;case 8:t="        ";break;case 9:t="         ";break;case 10:t="          ";break;case 11:t="           ";break;case 12:t="            "}var n=["\n"];for(ix=0;ix<100;ix++)n.push(n[ix]+t);return n}function t(){this.step="    ",this.shift=e(this.step)}function n(e,t){return t-(e.replace(/\(/g,"").length-e.replace(/\)/g,"").length)}function r(e,t){return e.replace(/\s{1,}/g," ").replace(/ AND /ig,"~::~"+t+t+"AND ").replace(/ BETWEEN /ig,"~::~"+t+"BETWEEN ").replace(/ CASE /ig,"~::~"+t+"CASE ").replace(/ ELSE /ig,"~::~"+t+"ELSE ").replace(/ END /ig,"~::~"+t+"END ").replace(/ FROM /ig,"~::~FROM ").replace(/ GROUP\s{1,}BY/ig,"~::~GROUP BY ").replace(/ HAVING /ig,"~::~HAVING ").replace(/ IN /ig," IN ").replace(/ JOIN /ig,"~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /ig,"~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /ig,"~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /ig,"~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /ig,"~::~RIGHT JOIN ").replace(/ ON /ig,"~::~"+t+"ON ").replace(/ OR /ig,"~::~"+t+t+"OR ").replace(/ ORDER\s{1,}BY/ig,"~::~ORDER BY ").replace(/ OVER /ig,"~::~"+t+"OVER ").replace(/\(\s{0,}SELECT /ig,"~::~(SELECT ").replace(/\)\s{0,}SELECT /ig,")~::~SELECT ").replace(/ THEN /ig," THEN~::~"+t+"").replace(/ UNION /ig,"~::~UNION~::~").replace(/ USING /ig,"~::~USING ").replace(/ WHEN /ig,"~::~"+t+"WHEN ").replace(/ WHERE /ig,"~::~WHERE ").replace(/ WITH /ig,"~::~WITH ").replace(/ ALL /ig," ALL ").replace(/ AS /ig," AS ").replace(/ ASC /ig," ASC ").replace(/ DESC /ig," DESC ").replace(/ DISTINCT /ig," DISTINCT ").replace(/ EXISTS /ig," EXISTS ").replace(/ NOT /ig," NOT ").replace(/ NULL /ig," NULL ").replace(/ LIKE /ig," LIKE ").replace(/\s{0,}SELECT /ig,"SELECT ").replace(/\s{0,}UPDATE /ig,"UPDATE ").replace(/ SET /ig," SET ").replace(/~::~{1,}/g,"~::~").split("~::~")}return t.prototype.xml=function(t,n){var r=t.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns\:/g,"~::~xmlns:").replace(/\s*xmlns\=/g,"~::~xmlns=").split("~::~"),i=r.length,s=!1,o=0,u="",a=0,f=n?e(n):this.shift;for(a=0;a<i;a++)if(r[a].search(/<!/)>-1){u+=f[o]+r[a],s=!0;if(r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1||r[a].search(/!DOCTYPE/)>-1)s=!1}else r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1?(u+=r[a],s=!1):/^<\w/.exec(r[a-1])&&/^<\/\w/.exec(r[a])&&/^<[\w:\-\.\,]+/.exec(r[a-1])==/^<\/[\w:\-\.\,]+/.exec(r[a])[0].replace("/","")?(u+=r[a],s||o--):r[a].search(/<\w/)>-1&&r[a].search(/<\//)==-1&&r[a].search(/\/>/)==-1?u=s?u+=r[a]:u+=f[o++]+r[a]:r[a].search(/<\w/)>-1&&r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[--o]+r[a]:r[a].search(/\/>/)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\?/)>-1?u+=f[o]+r[a]:r[a].search(/xmlns\:/)>-1||r[a].search(/xmlns\=/)>-1?u+=f[o]+r[a]:u+=r[a];return u[0]=="\n"?u.slice(1):u},t.prototype.json=function(e,t){var t=t?t:this.step;return typeof JSON=="undefined"?e:typeof e=="string"?JSON.stringify(JSON.parse(e),null,t):typeof e=="object"?JSON.stringify(e,null,t):e},t.prototype.css=function(t,n){var r=t.replace(/\s{1,}/g," ").replace(/\{/g,"{~::~").replace(/\}/g,"~::~}~::~").replace(/\;/g,";~::~").replace(/\/\*/g,"~::~/*").replace(/\*\//g,"*/~::~").replace(/~::~\s{0,}~::~/g,"~::~").split("~::~"),i=r.length,s=0,o="",u=0,a=n?e(n):this.shift;for(u=0;u<i;u++)/\{/.exec(r[u])?o+=a[s++]+r[u]:/\}/.exec(r[u])?o+=a[--s]+r[u]:/\*\\/.exec(r[u])?o+=a[s]+r[u]:o+=a[s]+r[u];return o.replace(/^\n{1,}/,"")},t.prototype.sql=function(t,i){var s=t.replace(/\s{1,}/g," ").replace(/\'/ig,"~::~'").split("~::~"),o=s.length,u=[],a=0,f=this.step,l=!0,c=!1,h=0,p="",d=0,v=i?e(i):this.shift;for(d=0;d<o;d++)d%2?u=u.concat(s[d]):u=u.concat(r(s[d],f));o=u.length;for(d=0;d<o;d++){h=n(u[d],h),/\s{0,}\s{0,}SELECT\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\s{0,}SET\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(u[d])?(a++,p+=v[a]+u[d]):/\'/.exec(u[d])?(h<1&&a&&a--,p+=u[d]):(p+=v[a]+u[d],h<1&&a&&a--);var m=0}return p=p.replace(/^\n{1,}/,"").replace(/\n{1,}/g,"\n"),p},t.prototype.xmlmin=function(e,t){var n=t?e:e.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g,"").replace(/[ \r\n\t]{1,}xmlns/g," xmlns");return n.replace(/>\s{0,}</g,"><")},t.prototype.jsonmin=function(e){return typeof JSON=="undefined"?e:JSON.stringify(JSON.parse(e),null,0)},t.prototype.cssmin=function(e,t){var n=t?e:e.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"");return n.replace(/\s{1,}/g," ").replace(/\{\s{1,}/g,"{").replace(/\}\s{1,}/g,"}").replace(/\;\s{1,}/g,";").replace(/\/\*\s{1,}/g,"/*").replace(/\*\/\s{1,}/g,"*/")},t.prototype.sqlmin=function(e){return e.replace(/\s{1,}/g," ").replace(/\s{1,}\(/,"(").replace(/\s{1,}\)/,")")},new t}),n("vis/utils",["lib/d3","lib/vkbeautify"],function(e,t){function n(e,t){var n=parseFloat(e.style("width"))-t.left-t.right,r=parseFloat(e.style("height"))-t.top-t.bottom;return{width:n,height:r}}function r(e,t){var n=parseFloat(e.attr("width"))-t.left-t.right,r=parseFloat(e.attr("height"))-t.top-t.bottom;return{width:n,height:r}}function i(e,t){if(e===undefined)return t;var n=-1,r=t,i=window.Object.keys(e);while(++n<i.length)r[i[n]]=e[i[n]];return r}function s(t,i,s,o){var u=function(t,r,i){t&&(e.select("body").style("margin","0").style("padding","0"),r.style("height",window.innerHeight-i.top+"px"),r.style("width",window.innerWidth-i.left+"px"),r.style("margin-left",i.left+"px"),r.style("margin-top",i.top+"px"));var s=n(r,i);return s.svg=r.append("svg").attr("width",s.width).attr("height",s.height).attr("xmlns","http://www.w3.org/2000/svg"),s},a;return i?(a=r(t,s),a.svg=t):t?a=u(o,t,s):a=u(o,e.select("body").append("div"),s),(a.height<=0||a.width<=0)&&console.warn("Container has invalid height or 			 width. Try setting styles for height 			 and width, or use the 'fill_screen' option."),a}function o(e,t,i,s){function u(e,t,r){e&&(t.style("height",window.innerHeight-r.top+"px"),t.style("width",window.innerWidth-r.left+"px"),t.style("margin-left",r.left+"px"),t.style("margin-top",r.top+"px"));var s=n(t,i);return t.select("svg").attr("height",s.height).attr("width",s.width),s}var o;return t?o=r(e,i):e?o=u(s,e,i):console.warn("No selection"),o}function u(e){var t=e.node();while(t.hasChildNodes())t.removeChild(t.lastChild)}function a(t,n){var r="";return t&&e.text(t,function(e,t){e&&console.warn(e),r=t,n(r)}),!1}function f(){return"omg yes"}function l(t,n,r,i){function s(e,t){return e.indexOf(t,e.length-t.length)!==-1}if(i){n&&console.warn("File "+n+" overridden by value."),r.call(t,null,i,n);return}if(!n){r.call(t,"No filename",null,n);return}s(n,"json")?e.json(n,function(e,t){r(e,t,n)}):s(n,"css")?e.text(n,function(e,t){r(e,t,n)}):r.call(t,"Unrecognized file type",null,n);return}function c(e,t,n){var r=-1,i=t.length,s={};while(++r<t.length){var o=t[r].file;s[o]=t[r].callback,l(e,o,function(t,r,o){s[o].call(e,t,r),--i||n.call(e)},t[r].value)}}function h(t,n,r,s,o){var u=i(o,{padding:{left:0,right:0,top:0,bottom:0},x_is_log:!1,y_is_log:!1,y_ticks:null,x_ticks:null,x_nice:!1,y_nice:!1,x_tick_format:null,y_tick_format:null}),a={};return u.x_is_log?a.x=e.scale.log():a.x=e.scale.linear(),a.x.range([u.padding.left,r-u.padding.right]).domain(t),n?(u.y_is_log?a.y=e.scale.log():a.y=e.scale.linear(),a.y.range([s-u.padding.bottom,1+u.padding.top]).domain(n)):a.y=null,t?(a.x_axis=e.svg.axis().scale(a.x).orient("bottom"),u.x_nice&&a.x_axis.nice(),u.x_ticks&&a.x_axis.ticks(u.x_ticks),u.x_tick_format&&a.x_axis.tickFormat(u.x_tick_format)):a.x=null,a.y_axis=e.svg.axis().scale(a.y).orient("left"),u.y_nice&&a.y_axis.nice(),u.y_ticks&&a.y_axis.ticks(u.y_ticks),u.y_tick_format&&a.y_axis.tickFormat(u.y_tick_format),a}function p(e,t,n,r,i,s,o){var u,a,f,l,c,h,p;return e=="x"?(u="x axis",a=[0,s-o.bottom],f=i,l=-6,p=0,c=0,h=0):e=="y"?(u="y axis",a=[o.left,0],f=0,l=6,p=-90,c=0,h=".71em"):console.warn("Bad axis type"),n.append("g").attr("class",u).attr("transform","translate("+a+")").call(r).append("text").attr("class","label").attr("transform","rotate("+p+")").attr("x",f).attr("y",l).attr("dx",c).attr("dy",h).style("text-anchor","end").text(t)}function d(){var e,t=function(n){if(!(this instanceof t)){e=!0;var r=new t(arguments);return e=!1,r}typeof this.init=="function"&&this.init.apply(this,e?n:arguments)};return t}function v(e,t){e.select("defs").remove();var n=e.append("defs");return n.append("style").attr("type","text/css").text(t),n}function m(t,n,r,i,s){var o=e.select(t).selectAll(n).data(r);o.enter().call(i),o.call(s),o.exit().remove()}function g(t,n,r,i,s,o){var u=e.select(t).selectAll(n).data(y(r,i),function(e){return e[i]});u.enter().call(s),u.call(o),u.exit().remove()}function y(e,t){var n=[];for(var r in e){var i=b(e[r]);i[t]=r,n.push(i)}return n}function b(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){var t=[];for(var n=0,r=e.length;n<r;n++)t[n]=b(e[n]);return t}if(e instanceof Object){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=b(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function w(e,t){for(var n in t)n in e?console.error("Attribute "+n+" already in object."):e[n]=t[n]}function E(e){var t=[];return e.forEach(function(e){e.forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t}function S(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x+t.x,y:e.y+t.y}}function x(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x-t.x,y:e.y-t.y}}function T(e,t){return{x:e.x*t,y:e.y*t}}function N(e,t){function s(e){return window.btoa(unescape(encodeURIComponent(e)))}var n=document.createElement("a");n.download=t+".json";var r=JSON.stringify(e);n.setAttribute("href-lang","text/json"),n.href="data:image/svg+xml;base64,"+s(r);var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)}function C(e,t){window.File&&window.FileReader&&window.FileList&&window.Blob||t("The File APIs are not fully supported in this browser.",null);var n=new window.FileReader;n.onload=function(e){var n=JSON.parse(e.target.result);t(null,n)},n.readAsText(e)}function k(n,r,i){function a(e){return window.btoa(unescape(encodeURIComponent(e)))}var s=document.createElement("a"),o,u;s.download=n+".svg",o=(new XMLSerializer).serializeToString(e.select(r).node()),i&&(o=t.xml(o)),o='<?xml version="1.0" encoding="utf-8"?>\n             <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"\n         "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'+o,s.setAttribute("href-lang","image/svg+xml"),s.href="data:image/svg+xml;base64,"+a(o),u=document.createEvent("MouseEvents"),u.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(u)}function L(e,t,n){var r=function(e){return A(e,t,n)};return e.map(r)}function A(e,t,n){var r=Math.cos(-t)*(e.x-n.x)+Math.sin(-t)*(e.y-n.y)+n.x-e.x,i=-Math.sin(-t)*(e.x-n.x)+Math.cos(-t)*(e.y-n.y)+n.y-e.y;return{x:r,y:i}}function O(e){var t=e[1].x-e[0].x,n=e[1].y-e[0].y;return t==0&&n>=0?Math.PI/2:t==0&&n<0?3*Math.PI/2:t>=0&&n>=0?Math.atan(n/t):t>=0?Math.atan(n/t)+2*Math.PI:Math.atan(n/t)+Math.PI}function M(e){return e*180/Math.PI}function _(e,t){return Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2))}return{set_options:i,setup_svg:s,resize_svg:o,remove_child_nodes:u,load_css:a,load_files:c,load_the_file:l,scale_and_axes:h,add_generic_axis:p,make_class:d,setup_defs:v,draw_an_array:m,draw_an_object:g,make_array:y,clone:b,extend:w,unique_concat:E,c_plus_c:S,c_minus_c:x,c_times_scalar:T,download_json:N,load_json:C,export_svg:k,rotate_coords_recursive:L,rotate_coords:A,get_angle:O,to_degrees:M,distance:_}}),n("lib/complete.ly",[],function(){return function(e,t){function h(e){return l===undefined&&(l=document.createElement("span"),l.style.visibility="hidden",l.style.position="fixed",l.style.outline="0",l.style.margin="0",l.style.padding="0",l.style.border="0",l.style.left="0",l.style.whiteSpace="pre",l.style.fontSize=t.fontSize,l.style.fontFamily=t.fontFamily,l.style.fontWeight="normal",document.body.appendChild(l)),l.innerHTML=String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),l.getBoundingClientRect().right}t=t||{},t.fontSize=t.fontSize||"16px",t.fontFamily=t.fontFamily||"sans-serif",t.promptInnerHTML=t.promptInnerHTML||"",t.color=t.color||"#333",t.hintColor=t.hintColor||"#aaa",t.backgroundColor=t.backgroundColor||"#fff",t.dropDownBorderColor=t.dropDownBorderColor||"#aaa",t.dropDownZIndex=t.dropDownZIndex||"100",t.dropDownOnHoverBackgroundColor=t.dropDownOnHoverBackgroundColor||"#ddd";var n=document.createElement("input");n.type="text",n.spellcheck=!1,n.style.fontSize=t.fontSize,n.style.fontFamily=t.fontFamily,n.style.color=t.color,n.style.backgroundColor=t.backgroundColor,n.style.width="100%",n.style.outline="0",n.style.border="0",n.style.margin="0",n.style.padding="0";var r=n.cloneNode();r.disabled="",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.borderColor="transparent",r.style.boxShadow="none",r.style.color=t.hintColor,n.style.backgroundColor="transparent",n.style.verticalAlign="top",n.style.position="relative";var i=document.createElement("div");i.style.position="relative",i.style.outline="0",i.style.border="0",i.style.margin="0",i.style.padding="0";var s=document.createElement("div");s.style.position="absolute",s.style.outline="0",s.style.margin="0",s.style.padding="0",s.style.border="0",s.style.fontSize=t.fontSize,s.style.fontFamily=t.fontFamily,s.style.color=t.color,s.style.backgroundColor=t.backgroundColor,s.style.top="0",s.style.left="0",s.style.overflow="hidden",s.innerHTML=t.promptInnerHTML,s.style.background="transparent";if(document.body===undefined)throw"document.body is undefined. The library was wired up incorrectly.";document.body.appendChild(s);var o=s.getBoundingClientRect().right;i.appendChild(s),s.style.visibility="visible",s.style.left="-"+o+"px",i.style.marginLeft=o+"px",i.appendChild(r),i.appendChild(n);var u=document.createElement("div");u.style.position="absolute",u.style.visibility="hidden",u.style.outline="0",u.style.margin="0",u.style.padding="0",u.style.textAlign="left",u.style.fontSize=t.fontSize,u.style.fontFamily=t.fontFamily,u.style.backgroundColor=t.backgroundColor,u.style.zIndex=t.dropDownZIndex,u.style.cursor="default",u.style.borderStyle="solid",u.style.borderWidth="1px",u.style.borderColor=t.dropDownBorderColor,u.style.overflowX="hidden",u.style.whiteSpace="pre",u.style.overflowY="scroll";var a=function(e){var n=[],r=0,i=-1,s=function(){this.style.outline="1px solid #ddd"},o=function(){this.style.outline="0"},u=function(){a.hide(),a.onmouseselection(this.__hint)},a={hide:function(){e.style.visibility="hidden"},refresh:function(i,f){e.style.visibility="hidden",r=0,e.innerHTML="";var l=window.innerHeight||document.documentElement.clientHeight,c=e.parentNode.getBoundingClientRect(),h=c.top-6,p=l-c.bottom-6;n=[];for(var d=0;d<f.length;d++){if(f[d].indexOf(i)!==0)continue;var v=document.createElement("div");v.style.color=t.color,v.onmouseover=s,v.onmouseout=o,v.onmousedown=u,v.__hint=f[d],v.innerHTML=i+"<b>"+f[d].substring(i.length)+"</b>",n.push(v),e.appendChild(v)}if(n.length===0)return;if(n.length===1&&i===n[0].__hint)return;if(n.length<2)return;a.highlight(0),h>p*3?(e.style.maxHeight=h+"px",e.style.top="",e.style.bottom="100%"):(e.style.top="100%",e.style.bottom="",e.style.maxHeight=p+"px"),e.style.visibility="visible"},highlight:function(e){i!=-1&&n[i]&&(n[i].style.backgroundColor=t.backgroundColor),n[e].style.backgroundColor=t.dropDownOnHoverBackgroundColor,i=e},move:function(t){return e.style.visibility==="hidden"?"":r+t===-1||r+t===n.length?n[r].__hint:(r+=t,a.highlight(r),n[r].__hint)},onmouseselection:function(){}};return a},f=a(u);f.onmouseselection=function(e){n.value=r.value=c+e,p.onChange(n.value),d=n.value,setTimeout(function(){n.focus()},0)},i.appendChild(u),e.appendChild(i);var l,c,p={onArrowDown:function(){},onArrowUp:function(){},onEnter:function(){},onTab:function(){},onChange:function(){p.repaint()},startFrom:0,options:[],wrapper:i,input:n,hint:r,dropDown:u,prompt:s,setText:function(e){r.value=e,n.value=e},getText:function(){return n.value},hideDropDown:function(){f.hide()},repaint:function(){var e=n.value,t=p.startFrom,i=p.options,s=i.length,o=e.substring(t);c=e.substring(0,t),r.value="";for(var a=0;a<s;a++){var l=i[a];if(l.indexOf(o)===0){r.value=c+l;break}}u.style.left=h(c)+"px",f.refresh(o,p.options)}},d,v=function(e,t){d=e.value;var n=function(){var n=e.value;d!==n&&(d=n,t(n))};e.addEventListener?(e.addEventListener("input",n,!1),e.addEventListener("keyup",n,!1),e.addEventListener("change",n,!1)):(e.attachEvent("oninput",n),e.attachEvent("onkeyup",n),e.attachEvent("onchange",n))};v(n,function(e){p.onChange(e)});var m=function(e){e=e||window.event;var t=e.keyCode;if(t==33)return;if(t==34)return;if(t==27){f.hide(),r.value=n.value,n.focus();return}if(t==39||t==35||t==9){t==9&&(e.preventDefault(),e.stopPropagation(),r.value.length==0&&p.onTab());if(r.value.length>0){f.hide(),n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==13){if(r.value.length==0)p.onEnter();else{var s=u.style.visibility=="hidden";f.hide();if(s){r.value=n.value,n.focus(),p.onEnter();return}n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==40){var o=f.move(1);o==""&&p.onArrowDown(),r.value=c+o;return}if(t==38){var o=f.move(-1);o==""&&p.onArrowUp(),r.value=c+o,e.preventDefault(),e.stopPropagation();return}r.value=""};return n.addEventListener?n.addEventListener("keydown",m,!1):n.attachEvent("onkeydown",m),p}}),n("builder/draw",["vis/utils","lib/d3"],function(e,t){function n(e){e.append("g").attr("id","membranes"),e.append("g").attr("id","reactions"),e.append("g").attr("id","nodes"),e.append("g").attr("id","text-labels")}function r(t,n,r,i,s,o,c,h,p,d,b,w,E,S,x,T){e.draw_an_array("#membranes",".membrane",t,u,function(e){return a(e,s)}),e.draw_an_object("#reactions",".reaction",n,"reaction_id",f,function(e){return l(e,s,r,o,c,h,p,d,b,T)}),e.draw_an_object("#nodes",".node",r,"node_id",function(e){return v(e,s,r,n,S,x)},function(e){return m(e,s,w,E)}),e.draw_an_object("#text-labels",".text-label",i,"text_label_id",g,function(e){return y(e,s)})}function i(){t.select("#membranes").selectAll(".membrane").remove(),t.select("#reactions").selectAll(".reaction").remove(),t.select("#nodes").selectAll(".node").remove(),t.select("#text-labels").selectAll(".text-label").remove()}function s(n,r,i,s,o,u,a,c,h,p,d){var v={},m=-1;while(++m<n.length)v[n[m]]=e.clone(r[n[m]]);n.length!=Object.keys(v).length&&console.warn("did not find correct reaction subset");var g=t.select("#reactions").selectAll(".reaction").data(e.make_array(v,"reaction_id"),function(e){return e.reaction_id});g.enter().call(f),g.call(function(e){return l(e,s,i,o,u,a,c,h,p,d)}),g.exit()}function o(n,r,i,s,o,u,a,f){var l={},c=-1;while(++c<n.length)l[n[c]]=e.clone(r[n[c]]);n.length!=Object.keys(l).length&&console.warn("did not find correct node subset");var h=t.select("#nodes").selectAll(".node").data(e.make_array(l,"node_id"),function(e){return e.node_id});h.enter().call(function(e){return v(e,s,r,i,a,f)}),h.call(function(e){return m(e,s,o,u)}),h.exit()}function u(e){e.append("rect").attr("class","membrane")}function a(e,t){e.attr("width",function(e){return t.x_size(e.width)}).attr("height",function(e){return t.y_size(e.height)}).attr("transform",function(e){return"translate("+t.x(e.x)+","+t.y(e.y)+")"}).style("stroke-width",function(e){return t.size(10)}).attr("rx",function(e){return t.x_size(20)}).attr("ry",function(e){return t.x_size(20)})}function f(e){var t=e.append("g").attr("id",function(e){return e.reaction_id}).attr("class","reaction").call(c);return}function l(t,n,r,i,s,o,u,a,f,l){t.select(".reaction-label").call(function(e){return h(e,n)});var c=t.selectAll(".segment-group").data(function(t){return e.make_array(t.segments,"segment_id")},function(e){return e.segment_id});c.enter().call(p),c.call(function(e){return d(e,n,r,i,s,o,u,a,f,l)}),c.exit().remove()}function c(e){e.append("text").attr("class","reaction-label label").attr("pointer-events","none")}function h(e,n,r){var i=t.format(".4g");e.text(function(e){var t=e.abbreviation;return e.flux?t+=" ("+i(e.flux)+")":r&&(t+=" (0)"),t}).attr("transform",function(e){return"translate("+n.x(e.label_x)+","+n.y(e.label_y)+")"}).style("font-size",function(e){return String(n.size(30))+"px"})}function p(e){var t=e.append("g").attr("class","segment-group").attr("id",function(e){return e.segment_id});t.append("path").attr("class","segment"),t.append("g").attr("class","beziers")}function d(e,n,r,i,s,o,u,a,f,l){function h(e,r){e.append("circle").attr("class",function(e){return"bezier bezier"+e.bezier}).style("stroke-width",String(n.size(1))+"px").attr("r",String(n.size(5))+"px").on("mouseover",function(e){t.select(this).style("stroke-width",String(n.size(3))+"px")}).on("mouseout",function(e){t.select(this).style("stroke-width",String(n.size(1))+"px")}).call(r)}function p(e,t){t?e.attr("visibility","visible").attr("transform",function(e){return e.x==null||e.y==null?"":"translate("+n.x(e.x)+","+n.y(e.y)+")"}):e.attr("visibility","hidden")}e.selectAll(".segment").datum(function(){return this.parentNode.__data__}).attr("d",function(e){if(e.from_node_id==null||e.to_node_id==null)return null;var t=r[e.from_node_id],i=r[e.to_node_id],o=e.b1,u=e.b2;return t["node_type"]=="metabolite"&&(t=b(s,t,o,"start")),i["node_type"]=="metabolite"&&(i=b(s,u,i,"end")),e.b1==null||e.b2==null?"M"+n.x(t.x)+","+n.y(t.y)+" "+n.x(i.x)+","+n.y(i.y):"M"+n.x(t.x)+","+n.y(t.y)+"C"+n.x(o.x)+","+n.y(o.y)+" "+n.x(u.x)+","+n.y(u.y)+" "+n.x(i.x)+","+n.y(i.y)}).attr("marker-start",function(e){var t=r[e.from_node_id];if(t["node_type"]=="metabolite"){var i=e.flux?n.flux_color(Math.abs(e.flux)):a,s=w(o,u,i,!1);return"url(#"+s+")"}return null}).attr("marker-end",function(e){var t=r[e.to_node_id];if(t["node_type"]=="metabolite"){var i=e.flux?n.flux_color(Math.abs(e.flux)):a,s=w(o,u,i,!0);return"url(#"+s+")"}return null}).style("stroke",function(e){return f?e.flux?n.flux_color(Math.abs(e.flux)):n.flux_color(0):a}).style("stroke-width",function(e){return e.flux?n.size(n.flux(Math.abs(e.flux))):n.size(n.flux(1))});var c=e.select(".beziers").selectAll(".bezier").data(function(e){var t=[],n=this.parentNode.parentNode.parentNode.__data__.reaction_id,r=this.parentNode.parentNode.__data__.segment_id;return e.b1!=null&&e.b1.x!=null&&e.b1.y!=null&&t.push({bezier:1,x:e.b1.x,y:e.b1.y,reaction_id:n,segment_id:r}),e.b2!=null&&e.b2.x!=null&&e.b2.y!=null&&t.push({bezier:2,x:e.b2.x,y:e.b2.y,reaction_id:n,segment_id:r}),t},function(e){return e.bezier});c.enter().call(function(e){return h(e,l)}),c.call(function(e){return p(e,i)}),c.exit().remove()}function v(e,n,r,i,s,o){var u=e.append("g").attr("class","node").attr("id",function(e){return e.node_id});u.append("circle").attr("class",function(e){return e.node_type=="metabolite"?"node-circle metabolite-circle":"node-circle"}).style("stroke-width",String(n.size(2))+"px").on("mouseover",function(e){t.select(this).style("stroke-width",String(n.size(3))+"px")}).on("mouseout",function(e){t.select(this).style("stroke-width",String(n.size(2))+"px")}).call(o).on("click",s),u.append("text").attr("class","node-label label").attr("pointer-events","none")}function m(e,n,r,i){var s=e.select(".node-circle").attr("transform",function(e){return"translate("+n.x(e.x)+","+n.y(e.y)+")"}).attr("r",function(e){return e.node_type=="metabolite"?r&&i.indexOf("Size")!==1?n.size(n.node_size(e.data)):n.size(e.node_is_primary?15:10):n.size(5)}).style("fill",function(e){if(e.node_type=="metabolite")return r&&i.indexOf("Color")!==1?n.node_color(e.data):"rgb(224, 134, 91)"});e.select(".node-label").attr("transform",function(e){return"translate("+n.x(e.label_x)+","+n.y(e.label_y)+")"}).style("font-size",function(e){return String(n.size(20))+"px"}).text(function(e){var n=t.format(".4g"),i=e.bigg_id_compartmentalized;return e.data?i+=" ("+n(e.data)+")":r&&(i+=" (0)"),i})}function g(e){e.append("text").attr("class","text-label label").text(function(e){return e.text})}function y(e,t){e.attr("transform",function(e){return"translate("+t.x(e.x)+","+t.y(e.y)+")"})}function b(t,n,r,i){var s=t,o=e.distance(n,r),u,a;return(!s||!o)&&console.error("Bad value"),i=="start"?(u=n.x+s*(r.x-n.x)/o,a=n.y+s*(r.y-n.y)/o):i=="end"?(u=r.x-s*(r.x-n.x)/o,a=r.y-s*(r.y-n.y)/o):console.error("bad displace value: "+i),{x:u,y:a}}function w(e,t,n,r){var i=r?"start-":"end-",s=String(n).replace("#",i);if(t.indexOf(s)<0){t.push(s);var o=5,u=5,a,f=o/2,l;r?a=0:a=u,r?l="M0,0 V"+o+" L"+u/2+","+o/2+" Z":l="M"+u+",0 V"+o+" L"+u/2+","+o/2+" Z",e.append("svg:marker").attr("id",s).attr("class","arrowhead").attr("refX",a).attr("refY",f).attr("markerWidth",o).attr("markerHeight",u).attr("orient","auto").append("svg:path").attr("d",l).style("fill",n)}return s}return{setup_containers:n,draw:r,reset:i,draw_specific_reactions:s,draw_specific_nodes:o}}),n("builder/build",["vis/utils","lib/d3"],function(e,t){function n(t,n,i,s,u,a,f){f=Math.PI/180*f;var l=String(++u.reactions),c={x:s.x,y:s.y},h=300,p=[c,e.c_plus_c(c,{x:h,y:0})],d={x:(p[0].x+p[1].x)/2,y:(p[0].y+p[1].y)/2},v={x:30,y:10},m=20,g=n.reversibility?"Reversible":"Irreversible",y={abbreviation:t,direction:g,label_x:d.x+v.x,label_y:d.y+v.y,name:n.name,segments:{}},b=[],w=[],E=0,S=0,x=!1;for(var T in n.metabolites){var N=n.metabolites[T];if(N.coefficient<0){N.index=E;var C=/C([0-9]+)/.exec(N.formula);s.bigg_id_compartmentalized==N.bigg_id_compartmentalized?b.push([N.index,Infinity]):C&&a.indexOf(N.bigg_id)==-1&&b.push([N.index,parseInt(C[1])]),E++}else{N.index=S;var C=/C([0-9]+)/.exec(N.formula);s.bigg_id_compartmentalized==N.bigg_id_compartmentalized?(w.push([N.index,Infinity]),x=!0):C&&a.indexOf(N.bigg_id)==-1&&w.push([N.index,parseInt(C[1])]),S++}}var k=function(e,t){return t[1]>e[1]?t:e},L=b.reduce(k,[0,0])[0],A=w.reduce(k,[0,0])[0];for(var T in n.metabolites){var N=n.metabolites[T];N.coefficient<0?(N.index==L&&(N.is_primary=!0),N.count=E+1):(N.index==A&&(N.is_primary=!0),N.count=S+1)}var O={},M=[{node_type:"anchor_reactants",dis:{x:m*(x?1:-1),y:0}},{node_type:"center",dis:{x:0,y:0}},{node_type:"anchor_products",dis:{x:m*(x?-1:1),y:0}}],_={};M.map(function(e){var t=String(++u.nodes);O[t]={node_type:e.node_type,x:d.x+e.dis.x,y:d.y+e.dis.y,connected_segments:[]},_[e.node_type]=t});var D=[[_.anchor_reactants,_.center],[_.anchor_products,_.center]];D.map(function(e){var t=e[0],n=e[1],r=String(++u.segments);y.segments[r]={b1:null,b2:null,from_node_id:t,to_node_id:n},O[t].connected_segments.push({segment_id:r,reaction_id:l}),O[n].connected_segments.push({segment_id:r,reaction_id:l})});var P=O;for(var T in n.metabolites){N=n.metabolites[T];var H,B;N.coefficient<0?(H=L,B=_.anchor_reactants):(H=A,B=_.anchor_products);var j=o(N,H,p,d,h,x);if(N.bigg_id_compartmentalized==s.bigg_id_compartmentalized){var F=String(++u.segments);y.segments[F]={from_node_id:B,to_node_id:i,b1:j.b1,b2:j.b2},s.connected_segments.push({segment_id:F,reaction_id:l}),P[B].connected_segments.push({segment_id:F,reaction_id:l})}else{var F=String(++u.segments),I=String(++u.nodes);y.segments[F]={from_node_id:B,to_node_id:I,b1:j.b1,b2:j.b2},P[I]={connected_segments:[{segment_id:F,reaction_id:l}],x:j.circle.x,y:j.circle.y,node_is_primary:N.is_primary,compartment_name:N.compartment,label_x:j.circle.x+v.x,label_y:j.circle.y+v.y,metabolite_name:N.name,bigg_id:N.bigg_id,bigg_id_compartmentalized:N.bigg_id_compartmentalized,node_type:"metabolite"},P[B].connected_segments.push({segment_id:F,reaction_id:l})}}var q={};q[l]=y,P[i]=s;var R=r(P,q,f,c);return{new_reactions:q,new_nodes:P}}function r(t,n,r,i){var o=function(t){return t===null?null:e.rotate_coords(t,r,i)},u=[],a=[];for(var f in t){var l=t[f],c=o({x:l.x,y:l.y}),h=s(l,n,c);l.connected_segments.map(function(t){var r=n[t.reaction_id];if(r===undefined)return;var i=r.segments[t.segment_id];if(i.to_node_id==f&&i.b2){var s=o(i.b2);i.b2=e.c_plus_c(i.b2,s)}else if(i.from_node_id==f&&i.b1){var s=o(i.b1);i.b1=e.c_plus_c(i.b1,s)}}),a=e.unique_concat([a,h.reaction_ids]),u.push(f)}return{node_ids:u,reaction_ids:a}}function i(t,n,r,i){var o=s(t,r,i);return t.connected_segments.map(function(t){var s=r[t.reaction_id];if(s===undefined)return;var u=s.segments[t.segment_id];u.from_node_id==n&&u.b1&&(u.b1=e.c_plus_c(u.b1,i)),u.to_node_id==n&&u.b2&&(u.b2=e.c_plus_c(u.b2,i)),o.reaction_ids.indexOf(t.reaction_id)<0&&o.reaction_ids.push(t.reaction_id)}),o}function s(e,t,n){e.x=e.x+n.x,e.y=e.y+n.y,e.label_x=e.label_x+n.x,e.label_y=e.label_y+n.y;var r=[];return e.connected_segments.map(function(i){var s=t[i.reaction_id];r.indexOf(i.reaction_id)<0&&(r.push(i.reaction_id),e.node_type=="center"&&(s.label_x=s.label_x+n.x,s.label_y=s.label_y+n.y))}),{reaction_ids:r}}function o(t,n,r,i,s,o){var u=r[0],r=[e.c_minus_c(r[0],u),e.c_minus_c(r[1],u)],i=e.c_minus_c(i,u),a=80,f=.4,l=.25,c=a*.7,h=40,p=Math.min(2,t.count-1),d,v,m;t.is_primary?d=20:(d=10,t.index>n?v=t.index-1:v=t.index);var g=s-d,y=[{x:d,y:0},{x:g,y:0}],b,w,E,S;t.coefficient<0!=o&&t.is_primary?(b={x:y[0].x,y:y[0].y},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x,y:r[0].y}):t.coefficient<0!=o?(b={x:y[0].x+h,y:y[0].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x+h,y:r[0].y+(a*v-a*(p-1)/2)}):t.coefficient>0!=o&&t.is_primary?(b={x:y[1].x,y:y[1].y},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x,y:r[1].y}):t.coefficient>0!=o&&(b={x:y[1].x-h,y:y[1].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x-h,y:r[1].y+(a*v-a*(p-1)/2)});var x={};return x.b1=e.c_plus_c(u,E),x.b2=e.c_plus_c(u,S),x.circle=e.c_plus_c(u,w),x}return{new_reaction:n,rotate_selected_nodes:r,move_node_and_dependents:i}}),n("builder/Behavior",["vis/utils","lib/d3","builder/build"],function(e,t,n){function i(e,t){this.map=e,this.undo_stack=t,this.empty_behavior=function(){},this.node_click=null,this.node_drag=this.empty_behavior,this.bezier_drag=this.empty_behavior,this.label_drag=this.empty_behavior,s()}function s(){u(!0),a(!0),f(!0)}function o(){u(!1),a(!1),f(!1)}function u(e){e===undefined&&(e=this.node_click==null);if(e){var n=this.map;this.node_click=function(r){n.select_metabolite(this,r),t.event.stopPropagation()}}else this.node_click=null}function a(e){e===undefined&&(e=this.node_drag===this.empty_behavior),e?(this.node_drag=l(this.map),this.bezier_drag=c(this.map)):this.node_drag=this.empty_behavior}function f(e){e===undefined&&(e=this.label_drag===this.empty_behavior),e||(this.label_drag=this.empty_behavior)}function l(r,i){function l(n,i){var s=r.nodes[i],o=r.nodes[n],u=[];return s.connected_segments.forEach(function(t){var s=r.reactions[t.reaction_id].segments[t.segment_id];if(s.from_node_id==i)s.from_node_id=n;else{if(s.to_node_id!=i)return console.error("Segment does not connect to dragged node");s.to_node_id=n}o.connected_segments.push(t),u.push(e.clone(t))}),r.delete_nodes_by_id([i]),t.selectAll(".node-to-combine").classed("node-to-combine",!1),r.draw_everything(),u}var s=t.behavior.drag(),o,u,a,f;return s.on("dragstart",function(){var e=this.parentNode.__data__,n=e.bigg_id_compartmentalized,i=this.parentNode;t.event.sourceEvent.stopPropagation(),o={},f=window.setTimeout(function(){i.parentNode.insertBefore(i,i.parentNode.firstChild)},200),t.selectAll(".metabolite-circle").on("mouseover.combine",function(i){i.bigg_id_compartmentalized==n&&i.node_id!=e.node_id&&t.select(this).style("stroke-width",String(r.scale.size(12))+"px").classed("node-to-combine",!0)}).on("mouseout.combine",function(i){i.bigg_id_compartmentalized==n&&i.node_id!==e.node_id&&t.select(this).style("stroke-width",String(r.scale.size(2))+"px").classed("node-to-combine",!1)})}),s.on("drag",function(){var i=this.parentNode.__data__.node_id,s=r.get_selected_node_ids();u=[],s.indexOf(i)==-1?u.push(i):u=s,a=[],u.forEach(function(i){var s=r.nodes[i],u={x:r.scale.x_size.invert(t.event.dx),y:r.scale.y_size.invert(t.event.dy)},f=n.move_node_and_dependents(s,i,r.reactions,u);a=e.unique_concat([a,f.reaction_ids]),i in o||(o[i]={x:0,y:0}),o[i]=e.c_plus_c(o[i],u)}),r.draw_specific_nodes(u),r.draw_specific_reactions(a)}),s.on("dragend",function(){var s=[];t.selectAll(".node-to-combine").each(function(e){s.push(e.node_id)});if(s.length==1){var c=s[0],h=this.parentNode.__data__.node_id,p=e.clone(r.nodes[h]),d=l(c,h);i.push(function(){r.nodes[h]=p;var e=r.nodes[c],t=[];d.forEach(function(n){var i=r.reactions[n.reaction_id].segments[n.segment_id];i.from_node_id==c?i.from_node_id=h:i.to_node_id==c?i.to_node_id=h:console.error("Segment does not connect to fixed node"),e.connected_segments=e.connected_segments.filter(function(e){return e.reaction_id!=n.reaction_id||e.segment_id!=n.segment_id}),t.indexOf(n.reaction_id)==-1&&t.push(n.reaction_id)}),r.draw_specific_nodes([h]),r.draw_specific_reactions(t)},function(){l(c,h)})}else{var v=e.clone(o),m=e.clone(u),g=e.clone(a);i.push(function(){m.forEach(function(t){var i=r.nodes[t];n.move_node_and_dependents(i,t,r.reactions,e.c_times_scalar(v[t],-1))}),r.draw_specific_nodes(m),r.draw_specific_reactions(g)},function(){m.forEach(function(e){var t=r.nodes[e];n.move_node_and_dependents(t,e,r.reactions,v[e])}),r.draw_specific_nodes(m),r.draw_specific_reactions(g)})}t.selectAll(".metabolite-circle").on("mouseover.combine",null).on("mouseout.combine",null),window.clearTimeout(f)}),s}function c(n,r){function f(t,r,i,s){var o=n.reactions[t].segments[r];o["b"+i]=e.c_plus_c(o["b"+i],s)}var i=t.behavior.drag(),s,o,u,a;return i.on("dragstart",function(){t.event.sourceEvent.stopPropagation(),s={x:0,y:0}}),i.on("drag",function(r){u=r.reaction_id,o=r.segment_id,a=r.bezier;var i={x:n.scale.x_size.invert(t.event.dx),y:n.scale.y_size.invert(t.event.dy)};f(u,o,a,i),s=e.c_plus_c(s,i),n.draw_specific_reactions([u])}),i.on("dragend",function(t){var i=e.clone(s),l=e.clone(u);r.push(function(){f(u,o,a,e.c_times_scalar(i,-1)),n.draw_specific_reactions([l])},function(){f(u,o,a,i),n.draw_specific_reactions([l])})}),i}function h(e){}function p(n,r){function f(t,r,i,s){var o=n.reactions[t].segments[r];o["b"+i]=e.c_plus_c(o["b"+i],s)}var i=t.behavior.drag(),s,o,u,a;return i.on("dragstart",function(){t.event.sourceEvent.stopPropagation(),s={x:0,y:0}}),i.on("drag",function(r){u=r.reaction_id,o=r.segment_id,a=r.bezier;var i={x:n.scale.x_size.invert(t.event.dx),y:n.scale.y_size.invert(t.event.dy)};f(u,o,a,i),s=e.c_plus_c(s,i),n.draw_specific_reactions([u])}),i.on("dragend",function(t){var i=e.clone(s),l=e.clone(u);r.push(function(){f(u,o,a,e.c_times_scalar(i,-1)),n.draw_specific_reactions([l])},function(){f(u,o,a,i),n.draw_specific_reactions([l])})}),i}var r=e.make_class();return r.prototype={init:i,turn_everything_on:s,turn_everything_off:o,toggle_node_click:u,toggle_node_drag:a,toggle_label_drag:f},r}),n("builder/Scale",["vis/utils","lib/d3"],function(e,t){function r(n,r,i,s,o){var u=e.set_options(o,{flux_color:t.scale.linear().domain([0,1e-6,1,8,50]).range(["rgb(200,200,200)","rgb(190,190,255)","rgb(100,100,255)","blue","red"])}),a=Math.min(i/n,s/r);u.x=t.scale.linear().domain([0,n]).range([(i-n*a)/2,n*a+(i-n*a)/2]),u.y=t.scale.linear().domain([0,r]).range([(s-r*a)/2,r*a+(s-r*a)/2]),u.x_size=t.scale.linear().domain([0,n]).range([0,n*a]),u.y_size=t.scale.linear().domain([0,r]).range([0,r*a]),u.size=t.scale.linear().domain([0,1]).range([0,a]),u.flux=t.scale.linear().domain([0,40]).range([6,6]),u.flux_fill=t.scale.linear().domain([0,40,200]).range([1,1,1]),u.node_size=t.scale.linear().range([5,25]),u.node_color=t.scale.linear().range(["white","red"]),u.metabolite_concentration=t.scale.linear().domain([0,10]).range([15,200]),u.metabolite_color=t.scale.linear().domain([0,1.2]).range(["#FEF0D9","#B30000"]),u.scale_path=function(e){var n=u.x,r=u.y,i=t.format(".2f"),e=e.replace(/(M|L)([0-9-.]+),?\s*([0-9-.]+)/g,function(e,t,s,o){return t+[i(n(parseFloat(s))),i(r(parseFloat(o)))].join(", ")}),s=/C([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)/g;return e=e.replace(s,function(e,t,s,o,u,a,f){return"C"+i(n(parseFloat(t)))+","+i(r(parseFloat(s)))+" "+i(n(parseFloat(o)))+","+i(r(parseFloat(u)))+" "+[i(n(parseFloat(a)))+","+i(r(parseFloat(f)))]}),e},u.scale_decimals=function(e,n,r){var i=t.format("."+String(r)+"f");return e=e.replace(/([0-9.]+)/g,function(e,t){return i(n(parseFloat(t)))}),e};var f=window.Object.keys(u),l=-1;while(++l<f.length)this[f[l]]=u[f[l]]}var n=e.make_class();return n.prototype={init:r},n}),n("builder/DirectionArrow",["vis/utils","lib/d3"],function(e,t){function r(e){function t(){return"M0 -5 L0 5 L20 5 L20 10 L30 0 L20 -10 L20 -5 Z"}this.arrow_container=e.append("g").attr("id","direction-arrow-container").attr("transform","translate(0,0)rotate(0)"),this.arrow=this.arrow_container.append("path").classed("direction-arrow",!0).attr("d",t()).style("visibility","hidden").attr("transform","translate(2,0)scale(0.15)")}function i(e){var n=t.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+e.x+","+e.y+")rotate("+n.rotate+")")}function s(e){var n=t.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+n.translate+")rotate("+e+")")}function o(){return t.transform(this.arrow_container.attr("transform")).rotate}function u(){this.arrow.style("visibility","visible")}function a(){this.arrow.style("visibility","hidden")}var n=e.make_class();return n.prototype={init:r,set_location:i,set_rotation:s,get_rotation:o,show:u,hide:a},n}),n("builder/UndoStack",["vis/utils"],function(e){function n(){var e=40;this.stack=Array(e),this.current=-1,this.oldest=-1,this.newest=-1,this.end_of_stack=!0,this.top_of_stack=!0}function r(e,t){this.current=o(this.current,this.stack.length),this.end_of_stack?this.oldest=this.current:this.oldest==this.current&&(this.oldest=o(this.oldest,this.stack.length)),this.stack[this.current]={undo:e,redo:t},this.newest=this.current,this.top_of_stack=!0,this.end_of_stack=!1}function i(){if(this.end_of_stack)return console.warn("End of stack.");this.stack[this.current].undo(),this.current==this.oldest?this.end_of_stack=!0:this.current=u(this.current,this.stack.length),this.top_of_stack=!1}function s(){if(this.top_of_stack)return console.warn("Top of stack.");this.end_of_stack||(this.current=o(this.current,this.stack.length)),this.stack[this.current].redo(),this.current==this.newest&&(this.top_of_stack=!0),this.end_of_stack=!1}function o(e,t){return e+1>t-1?0:e+1}function u(e,t){return e-1<0?t-1:e-1}var t=e.make_class();return t.prototype={init:n,push:r,undo:i,redo:s},t}),n("vis/CallbackManager",["vis/utils"],function(e){function n(){}function r(e,t){this.callbacks===undefined&&(this.callbacks={}),this.callbacks[e]===undefined&&(this.callbacks[e]=[]),this.callbacks[e].push(t)}function i(e){(this.callbacks===undefined||Object.keys(this.callbacks).length==0)&&console.warn("No callbacks to remove"),delete this.callbacks[e]}function s(e){if(this.callbacks===undefined)return;var t=Array.prototype.slice.call(arguments,1);for(var n in this.callbacks){var r=n.split(".")[0];r==e&&this.callbacks[n].forEach(function(e){e.apply(null,t)})}}var t=e.make_class();return t.prototype={init:n,set:r,remove:i,run:s},t}),n("builder/Map",["vis/utils","lib/d3","builder/draw","builder/Behavior","builder/Scale","builder/DirectionArrow","builder/build","builder/UndoStack","vis/CallbackManager"],function(e,t,n,r,i,s,o,u,a){function l(e,t,o,f,l,c,h,p){var d=90;this.reaction_arrow_displacement=35,n.setup_containers(e),this.sel=e,this.defs=t,this.zoom_container=o,this.flux=c,this.node_data=h,this.cobra_model=p,this.map_info={max_map_w:l*10,max_map_h:f*10},this.map_info.largest_ids={reactions:-1,nodes:-1,segments:-1},this.scale=new i(this.map_info.max_map_w,this.map_info.max_map_h,l,f),this.undo_stack=new u,this.behavior=new r(this,this.undo_stack);var v={x:0,y:0},m=1;this.beziers_enabled=!1,this.direction_arrow=new s(e),this.direction_arrow.set_rotation(d),this.callback_manager=new a,this.arrowheads_generated=[],this.nodes={},this.reactions={},this.membranes=[],this.text_labels={},this.info={},this.debug=!1}function c(e,t,n,r,i,s,o,u,a){function d(e,t){return t===undefined&&(t=0),e===undefined?t:Math.max.apply(null,Object.keys(e).map(function(e){return parseInt(e)}).concat([t]))}e=h(e);var l=new f(t,n,r,i,s,o,u,a);e.reactions&&(l.reactions=e.reactions),e.nodes&&(l.nodes=e.nodes),e.membranes&&(l.membranes=e.membranes),e.text_labels&&(l.text_labels=e.text_labels),e.info&&(l.info=e.info),l.map_info.largest_ids.reactions=d(l.reactions),l.map_info.largest_ids.nodes=d(l.nodes),l.map_info.largest_ids.text_labels=d(l.text_labels);var c=0;for(var p in l.reactions)c=d(l.reactions[p].segments,c);return l.map_info.largest_ids.segments=c,o&&l.apply_flux_to_map(),u&&l.apply_node_data_to_map(),l}function h(e){if(this.debug){var t=["node_type","x","y","connected_segments"],n=["segments","name","direction","abbreviation"],r=["from_node_id","to_node_id"],i=["text","x","y"];for(var s in e.nodes){var o=e.nodes[s];o.selected=!1,o.previously_selected=!1,t.map(function(e){o.hasOwnProperty(e)||console.error("Missing property "+e)})}for(var u in e.reactions){var a=e.reactions[u];n.map(function(e){a.hasOwnProperty(e)||console.error("Missing property "+e)});for(var f in a.segments){var l=a.segments[f];r.map(function(e){l.hasOwnProperty(e)||console.error("Missing property "+e)})}}for(var c in e.text_labels){var h=e.text_labels[c];i.map(function(e){h.hasOwnProperty(e)||console.error("Missing property "+e)})}}return e}function p(){return Boolean(this.flux)}function d(){return Boolean(this.node_data)}function v(){n.draw(this.membranes,this.reactions,this.nodes,this.text_labels,this.scale,this.beziers_enabled,this.reaction_arrow_displacement,this.defs,this.arrowheads_generated,this.default_reaction_color,p(),d(),this.node_data_style,this.behavior.node_click,this.behavior.node_drag,this.behavior.bezier_drag)}function m(e){n.draw_specific_reactions(e,this.reactions,this.nodes,this.scale,this.beziers_enabled,this.reaction_arrow_displacement,this.defs,this.arrowheads_generated,this.default_reaction_color,p(),this.behavior.node_drag)}function g(e){n.draw_specific_nodes(e,this.nodes,this.reactions,this.scale,d(),this.node_data_style,this.behavior.node_click,this.behavior.node_drag)}function y(){this.apply_flux_to_reactions(this.reactions)}function b(e){for(var t in e){var n=e[t];if(n.abbreviation in this.flux){var r=parseFloat(this.flux[n.abbreviation]);n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}else{var r=0;n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}}}function w(){this.apply_node_data_to_nodes(this.nodes)}function E(e){var t=[];for(var n in e){var r=e[n],i=0;r.bigg_id_compartmentalized in this.node_data&&(i=parseFloat(this.node_data[r.bigg_id_compartmentalized])),t.push(i),r.data=i}var s=Math.min.apply(null,t),o=Math.max.apply(null,t);this.scale.node_size.domain([s,o]),this.scale.node_color.domain([s,o])}function S(e){var t=this.nodes[e],n={x:t.x,y:t.y};return n}function x(){var e=[];return t.select("#nodes").selectAll(".selected").each(function(t){e.push(t.node_id)}),e}function T(){var e={};return t.select("#nodes").selectAll(".selected").each(function(t){e[t.node_id]=this.nodes[t.node_id]}),e}function N(e){var t=this.sel.select("#nodes").selectAll(".node"),n,r=this.scale;t.classed("selected",function(t){var i=String(t.node_id)==String(e);return i&&(n={x:r.x(t.x),y:r.y(t.y)}),i}),this.direction_arrow.set_location(n),this.direction_arrow.show(),this.sel.selectAll(".start-reaction-target").style("visibility","hidden"),this.callback_manager.run("select_metabolite_with_id")}function C(e,n){var r=this.sel.select("#nodes").selectAll(".node"),i=this.shift_key_on;i?t.select(e.parentNode).classed("selected",!t.select(e.parentNode).classed("selected")):r.classed("selected",function(e){return n===e});var s=t.select(".selected"),o=0,u;s.each(function(e){u={x:this.scale.x(e.x),y:this.scale.y(e.y)},o++}),this.callback_manager.run("select_metabolite",o),o==1?(this.direction_arrow.set_location(u),this.direction_arrow.show()):this.direction_arrow.hide(),this.sel.selectAll(".start-reaction-target").style("visibility","hidden")}function k(){this.toggle_beziers(!0)}function L(){this.toggle_beziers(!1)}function A(e){e===undefined?this.beziers_enabled=!this.beziers_enabled:this.beziers_enabled=e,v(),this.callback_manager.run("toggle_beziers",this.beziers_enabled)}function O(t,n){function p(t,n){e.extend(this.nodes,t),this.draw_these_nodes([n])}for(var r in this.reactions)if(this.reactions[r].abbreviation==t){console.warn("reaction is already drawn");return}this.cobra_model||console.error("No CobraModel. Cannot build new reaction");var i=e.clone(this.cobra_model.reactions[t]);for(var s in i.metabolites){var o=i.metabolites[s];if(o.coefficient<0){var u=++this.map_info.largest_ids.nodes,a={x:30,y:10},f={connected_segments:[],x:n.x,y:n.y,node_is_primary:!0,compartment_name:o.compartment,label_x:n.x+a.x,label_y:n.y+a.y,metabolite_name:o.name,bigg_id:o.bigg_id,bigg_id_compartmentalized:o.bigg_id_compartmentalized,node_type:"metabolite"},l={};l[u]=f;break}}p.apply(this,[l,u]);var c=e.clone(l),h=this;this.undo_stack.push(function(){D(l),l=e.clone(c),v()},function(){p.apply(h,[l,u])}),this.new_reaction_for_metabolite(t,u)}function M(t,n){function p(t,n,r){e.extend(this.reactions,n),delete this.nodes[r],e.extend(this.nodes,t),this.draw_these_nodes(Object.keys(t)),this.draw_these_reactions(Object.keys(n));for(var i in t){var s=t[i];if(s.node_is_primary&&i!=r){this.select_metabolite_with_id(i);var o={x:s.x,y:s.y};this.zoom_container&&this.zoom_container.translate_off_screen(o,this.scale.x,this.scale.y)}}}for(var r in this.reactions)if(this.reactions[r].abbreviation==t){console.warn("reaction is already drawn");return}var i=this.nodes[n],s=e.clone(this.cobra_model.reactions[t]),u=o.new_reaction(t,s,n,e.clone(i),this.map_info.largest_ids,this.cobra_model.cofactors,this.direction_arrow.get_rotation()),a=u.new_nodes,f=u.new_reactions;this.flux&&this.apply_flux_to_reactions(f),this.node_data&&this.apply_node_data_to_nodes(a),p.apply(this,[a,f,n]);var l=e.clone(a),c=e.clone(f),h=this;this.undo_stack.push(function(){delete a[n],D(a),B(f),N.apply(h,[n]),a=e.clone(l),f=e.clone(c),v()},function(){p.apply(h,[a,f,n])})}function _(t){var n=[],r={},i={};for(var s in t){var o=t[s];o.connected_segments.forEach(function(t){var r=this.reactions[t.reaction_id],s=r.segments[t.segment_id],o=e.clone(t);o.segment=e.clone(s),n.push(o),t.reaction_id in i||(i[t.reaction_id]=0),i[t.reaction_id]++})}for(var u in i){var a=this.reactions[u];Object.keys(a.segments).length==i[u]&&(r[u]=a)}return{segment_objs_w_segments:n,reactions:r}}function D(e){for(var t in e)delete this.nodes[t]}function P(e){e.forEach(function(e){delete this.nodes[e]})}function H(e){e.forEach(function(e){var t=this.reactions[e.reaction_id],n=t.segments[e.segment_id];[n.from_node_id,n.to_node_id].forEach(function(t){if(!(t in this.nodes))return;var n=this.nodes[t],r=n.connected_segments;r=r.filter(function(t){return t.segment_id!=e.segment_id})}),delete t.segments[e.segment_id]})}function B(e){for(var t in e)delete this.reactions[t]}function j(e){var n=t.select("body").select("#status");return n.empty()&&(n=t.select("body").append("text").attr("id","status")),n.text(e),this}function F(e){e===undefined&&(e=180);var t={x:null,y:null},n={x:null,y:null};for(var r in this.nodes){var i=this.nodes[r];t.x===null&&(t.x=this.scale.x(i.x)),t.y===null&&(t.y=this.scale.y(i.y)),n.x===null&&(n.x=this.scale.x(i.x)),n.y===null&&(n.y=this.scale.y(i.y)),t.x=Math.min(t.x,this.scale.x(i.x)),t.y=Math.min(t.y,this.scale.y(i.y)),n.x=Math.max(n.x,this.scale.x(i.x)),n.y=Math.max(n.y,this.scale.y(i.y))}var s=Math.min((this.width-e*2)/(n.x-t.x),(this.height-e*2)/(n.y-t.y)),o={x:-(t.x*s)+e+(this.width-e*2-(n.x-t.x)*s)/2,y:-(t.y*s)+e+(this.height-e*2-(n.y-t.y)*s)/2};this.zoom_container.scale(s),this.zoom_container.translate(o)}function I(){console.log("Saving"),e.download_json(this.map_for_export(),"saved_map")}function q(){console.error("not implemented")}function R(){console.log("Exporting SVG"),this.callback_manager.run("before_svg_export"),e.export_svg("saved_map","svg"),this.callback_manager.run("after_svg_export")}var f=e.make_class();return f.from_data=c,f.prototype={init:l,select_metabolite:C,new_reaction_from_scratch:O,new_reaction_for_metabolite:M,draw_everything:v,draw_these_reactions:m,draw_these_nodes:g,apply_flux_to_map:y,apply_flux_to_reactions:b,apply_node_data_to_map:w,apply_node_data_to_nodes:E,select_metabolite_with_id:N,toggle_beziers:A,hide_beziers:L,show_beziers:k,zoom_extent:F,save:I,map_for_export:q,save_svg:R},f}),n("builder/ZoomContainer",["vis/utils","lib/d3","vis/CallbackManager"],function(e,t,n){function i(e,r,i,s){this.zoom_on=!0,this.initial_zoom=1,this.window_translate={x:0,y:0},this.window_scale=1,this.callback_manager=new n,e.select("#zoom-container").remove();var o=e.append("g").attr("id","zoom-container");this.zoomed_sel=o.append("g");var u=function(e,t){e.zoom_on&&(e.zoomed_sel.attr("transform","translate("+t.translate+")"+"scale("+t.scale+")"),e.window_translate={x:t.translate[0],y:t.translate[1]},e.window_scale=t.scale,e.callback_manager.run("zoom"))},a=this;this.zoom_behavior=t.behavior.zoom().on("zoom",function(){u(a,t.event)}),o.call(this.zoom_behavior),this.saved_scale=null,this.saved_translate=null}function s(t){t===undefined?this.zoom_on=!this.zoom_on:this.zoom_on=t,this.zoom_on?(this.saved_scale!==null&&(this.zoom_behavior.scale(this.saved_scale),this.saved_scale=null),this.saved_translate!==null&&(this.zoom_behavior.translate(this.saved_translate),this.saved_translate=null)):(this.saved_scale===null&&(this.saved_scale=e.clone(this.zoom_behavior.scale())),this.saved_translate===null&&(this.saved_translate=e.clone(this.zoom_behavior.translate())))}function o(e){if(!e)return console.error("Bad scale value");this.zoom_behavior.scale(e),this.saved_scale!==null&&(this.saved_scale=e)}function u(e){if(!e||!e.x||!e.y)return console.error("Bad translate value");this.zoom_behavior.translate([e.x,e.y]),this.saved_translate!==null&&(this.saved_translate=e)}function a(e,t,n){function s(){this.zoom_container.translate([this.window_translate.x,this.window_translate.y]),this.zoom_container.scale(this.window_scale),this.sel.transition().attr("transform","translate("+this.window_translate.x+","+this.window_translate.y+")scale("+this.window_scale+")")}var r=80,i={x:{min:-this.window_translate.x/this.window_scale+r/this.window_scale,max:-this.window_translate.x/this.window_scale+(this.width-r)/this.window_scale},y:{min:-this.window_translate.y/this.window_scale+r/this.window_scale,max:-this.window_translate.y/this.window_scale+(this.height-r)/this.window_scale}};t(e.x)<i.x.min?(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.min)*this.window_scale,s()):t(e.x)>i.x.max&&(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.max)*this.window_scale,s()),n(e.y)<i.y.min?(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.min)*this.window_scale,s()):n(e.y)>i.y.max&&(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.max)*this.window_scale,s())}function f(){this.translate([0,0]),this.scale(1)}var r=e.make_class();return r.prototype={init:i,toggle_zoom:s,translate:u,scale:o,translate_off_screen:a,reset:f},r}),n("builder/Input",["lib/d3","vis/utils","lib/complete.ly","builder/Map","builder/ZoomContainer"],function(e,t,n,r,i){function o(t,s,o){var u=t.append("div").attr("id","rxn-input");u.style("display","none"),this.is_visible=!1;var a=n(u.node(),{backgroundColor:"#eee"});e.select(a.input).on("input",function(){this.value=this.value.replace("/","").replace(" ","").replace("\\","").replace("<","")}),this.sel=u,this.complete=a,s instanceof r?(this.map=s,this.setup_map_callbacks()):console.error("Cannot set the map. It is not an instance of builder/Map"),o instanceof i?(this.zoom_container=o,this.setup_zoom_callbacks()):console.error("Cannot set the zoom_container. It is not an instance of builder/ZoomContainer")}function u(){var e=this;this.map.callback_manager.set("select_metabolite_with_id.input",function(){e.is_visible&&e.show()}),this.map.callback_manager.set("select_metabolite.input",function(t){t==1?e.toggle():e.hide()})}function a(){var e=this;this.zoom_container.callback_manager.set("zoom.input",function(){e.is_visible&&console.error("unfinished")})}function f(){this.toggle(!0),this.sel.style("display","block")}function l(){this.toggle(!1)}function c(e){e===undefined&&(this.is_visible=!this.is_visible),this.is_visible?this.sel.style("display","block"):(this.sel.style("display","none"),this.selection.style("display","none"),this.completely.input.blur(),this.completely.hideDropDown()),this.sel.style("display","none")}function h(t,n,r,i,s,o,u,a){!this.x_scale|!this.y_scale&&console.error("Scale is not set for the reaction input"),e.select(".selected").each(function(f){e.selectAll(".selected").classed("selected",function(e){return f===e}),m({x:f.x,y:f.y},this.x_scale,this.y_scale,t,n,r,i,s,o,u,!1,a)})}function p(e,t,n,r,i,s,o,u,a){!this.x_scale|!this.y_scale&&console.error("Scale is not set for the reaction input"),m(e,this.x_scale,this.y_scale,t,n,r,i,s,o,u,!0,a)}function d(t,n,r,i){!this.map.scale.x|!this.map.scale.y&&console.error("Scale is not set for the reaction input"),e.select(".selected").each(function(e){this.place({x:e.x,y:e.y},t,n,r,i)})}function v(e,t,n,r,i,s,o){var u={x:200,y:0},a=Math.max(20,Math.min(s-270,r*t(e.x)+i.x-u.x)),f=Math.max(20,Math.min(o-40,r*n(e.y)+i.y-u.y));this.selection.style("position","absolute").style("display","block").style("left",a+"px").style("top",f+"px")}function m(n,r,i,s,o,u,a,f,l,c,h,p){function O(e,t){for(var n in t)if(t[n].abbreviation==e)return!0;return!1}function M(e,t,n){return e+": "+n(t)}var d=e.format(".3g");this.place(n,r,i,s,o,u,a),this.completely.input.blur(),this.completely.repaint();if(!h){var v=e.selectAll(".selected"),m=0,g,y;v.each(function(e){m++,g=e,y=parseInt(e.node_id)});if(m>1){console.error("Too many selected nodes");return}if(m==0){console.error("No selected node");return}}var b=[];for(var w in c){var E=c[w];if(O(w,l))continue;for(var S in E.metabolites){var x=E.metabolites[S];if(!h&&g.bigg_id_compartmentalized!=S)continue;if(w in b)continue;var T,N;f?(w in f?T=f[w]*(x.coefficient<1?1:-1):T=0,N=M(w,T,d),b[w]={flux:T,string:N}):b[w]={string:w}}}var C=[],k=t.make_array(b,"reaction_abbreviation");f&&k.sort(function(e,t){return Math.abs(t.flux)-Math.abs(e.flux)}),k.forEach(function(e){C.push(e.string)});var L=20,A=this.completely;A.options=C,C.length==1?A.setText(C[0]):A.setText(""),A.onEnter=function(){var e=this.getText();this.setText(""),k.map(function(t){t.string==e&&(h?p(t.reaction_abbreviation,n):p(t.reaction_abbreviation,y))})},A.repaint(),this.completely.input.focus()}var s=t.make_class();return s.prototype={init:o,setup_map_callbacks:u,setup_zoom_callbacks:a,show:f,hide:l,reload_at_selected:h,reload_at_point:p,place_at_selected:d,place:v},s}),n("builder/KeyManager",["vis/utils","lib/d3"],function(e,t){function r(e,n){function s(){return{command:!1,control:!1,option:!1,shift:!1}}function u(e,t,n,r){for(var i in e)e[i]==n&&(t[i]=r);return t}function a(e,t,n){if(e.key!=t)return!1;var r=e.modifiers;r===undefined&&(r={control:!1,command:!1,option:!1,shift:!1});for(var i in n){r[i]===undefined&&(r[i]=!1);if(r[i]!=n[i])return!1}return!0}this.reaction_input=n;var r=s(),i={command:91,control:17,option:18,shift:16};t.select(window).on("keydown",function(){var o=t.event.keyCode,f=n.is_visible,l=!0;r=u(i,r,o,!0),this.shift_key_on=r.shift;for(var c in e){var h=e[c];if(a(h,o,r)){l=!1;if(!h.ignore_with_input||!f)h.fn(),t.event.preventDefault()}}for(var p in i)i[p]==o&&(l=!1);l&&(r=s())}).on("keyup",function(){r=u(i,r,t.event.keyCode,!1),o.shift_key_on=r.shift})}function i(e){var n=t.select(window);return n.on("keydown.esc",function(){t.event.keyCode==27&&(e(),n.on("keydown.esc",null))}),{clear:function(){n.on("keydown.esc",null)}}}function s(e){if(e===undefined)o.start_reaction_listener=!o.start_reaction_listener;else{if(o.start_reaction_listener==e)return;o.start_reaction_listener=e}o.start_reaction_listener?(o.sel.on("click.start_reaction",function(){console.log("clicked for new reaction");var e={x:o.scale.x_size.invert(t.mouse(this)[0]),y:o.scale.y_size.invert(t.mouse(this)[1])};t.selectAll(".selected").classed("selected",!1),input.reload_at_point(o.reaction_input,e,o.scale.x,o.scale.y,o.window_scale,o.window_translate,o.width,o.height,o.flux,o.drawn_reactions,o.cobra_reactions,new_reaction_from_scratch);var n=o.sel.selectAll(".start-reaction-target").data([12,5]);n.enter().append("circle").classed("start-reaction-target",!0).attr("r",function(e){return o.scale.x_size(e)}).style("stroke-width",o.scale.x_size(4)),n.style("visibility","visible").attr("transform","translate("+o.scale.x(e.x)+","+o.scale.y(e.y)+")")}),o.sel.classed("start-reaction-cursor",!0)):(o.sel.on("click.start_reaction",null),o.sel.classed("start-reaction-cursor",!1),o.sel.selectAll(".start-reaction-target").style("visibility","hidden"))}function u(){console.log("Loading"),o.load_input_click_fn()}function a(){console.log("Loading flux"),o.load_flux_input_click_fn()}function f(){o.show_beziers?c():l()}function l(){o.show_beziers=!0,t.select("#bezier-button").text("Hide control points (b)").on("click",c),draw_everything()}function c(){o.show_beziers=!1,t.select("#bezier-button").text("Show control points (b)").on("click",l),draw_everything()}function h(){o.zoom_container.toggle_zoom(!0),enable_brush(!1),t.select("#zoom-button").text("Enable select (v)").on("click",p)}function p(){o.zoom_container.toggle_zoom(!1),enable_brush(!0),t.select("#zoom-button").text("Enable pan+zoom (z)").on("click",h)}function d(){function c(e,n){console.log("Choose center"),set_status("Choose a node or point to rotate around.");var r=t.selectAll(".node-circle"),s=t.selectAll("#mouse-node"),u=i(function(){console.log("choose_center escape"),r.on("mousedown.center",null),s.on("mousedown.center",null),set_status(""),n()});r.on("mousedown.center",function(t){console.log("mousedown.center"),r.on("mousedown.center",null),s.on("mousedown.center",null),set_status(""),u.clear();var n={x:t.x,y:t.y};e(n)}),s.on("mousedown.center",function(){console.log("mousedown.center"),r.on("mousedown.center",null),s.on("mousedown.center",null),set_status(""),u.clear();var n={x:o.scale.x_size.invert(t.mouse(this)[0]),y:o.scale.y_size.invert(t.mouse(this)[1])};e(n)})}function h(e,n,r,s){function c(e,t,n){var r=Math.atan2(t.x-n.x,n.y-t.y),i=Math.atan2(t.x-n.x+e.dx,n.y-t.y-e.dy),s=i-r;return s}console.log("listen_for_rotation"),set_status("Drag to rotate."),o.zoom_container.toggle_zoom(!1);var u=Math.PI/2,a=t.selectAll("#mouse-node"),f=t.behavior.drag(),l=i(function(){console.log("listen_for_rotation escape"),f.on("drag.rotate",null),f.on("dragend.rotate",null),set_status(""),s()});f.on("drag.rotate",function(){n(c({dx:o.scale.x_size.invert(t.event.dx),dy:o.scale.y_size.invert(t.event.dy)},{x:o.scale.x_size.invert(t.mouse(this)[0]),y:o.scale.y_size.invert(t.mouse(this)[1])},e))}).on("dragend.rotate",function(){console.log("dragend.rotate"),f.on("drag.rotate",null),f.on("dragend.rotate",null),set_status(""),l.clear(),r()}),a.call(f)}var e=get_selected_nodes();if(e.length<1)return console.warn("No nodes selected");var n=o.zoom_container.zoom_enabled(),r=o.metabolite_click_enabled,s=brush_is_enabled(),u=function(){o.zoom_container.toggle_zoom(n),o.metabolite_click_enabled=r,enable_brush(s)};o.zoom_container.toggle_zoom(!1),o.metabolite_click_enabled=!1,enable_brush(!1);var a,f=0,l=Object.keys(e);c(function(t){a=t,h(t,function(n){f+=n;var r=build.rotate_selected_nodes(e,o.drawn_reactions,n,t);draw_these_nodes(r.node_ids),draw_these_reactions(r.reaction_ids)},u,u)},u),o.undo_stack.push(function(){var e={};l.forEach(function(t){e[t]=o.drawn_nodes[t]});var t=build.rotate_selected_nodes(e,o.drawn_reactions,-f,a);draw_these_nodes(t.node_ids),draw_these_reactions(t.reaction_ids)},function(){var e={};l.forEach(function(t){e[t]=o.drawn_nodes[t]});var t=build.rotate_selected_nodes(e,o.drawn_reactions,f,a);draw_these_nodes(t.node_ids),draw_these_reactions(t.reaction_ids)})}function v(){function f(e,n,r){delete_nodes(t),delete_segments(r),delete_reactions(n),draw_everything()}var t=get_selected_nodes();if(t.length<1)return console.warn("No nodes selected");var n=segments_and_reactions_for_nodes(t),r=n.reactions,i=n.segment_objs_w_segments,s=e.clone(t),u=e.clone(i),a=e.clone(r);f(t,r,i),o.undo_stack.push(function(){e.extend(o.drawn_nodes,s),e.extend(o.drawn_reactions,a);var n=Object.keys(a);u.forEach(function(e){o.drawn_reactions[e.reaction_id].segments[e.segment_id]=e.segment,n.push(e.reaction_id)}),draw_these_nodes(Object.keys(s)),draw_these_reactions(n),t=e.clone(s),i=e.clone(u),r=e.clone(a)},function(){f(t,r,i)})}function m(){var e=get_selected_nodes();if(Object.keys(e).length!=1)return console.error("Only one node can be selected");var t=Object.keys(e)[0],n=e[t];o.drawn_nodes[t].node_is_primary=!0;var r=[t],i=[];o.drawn_nodes[t].connected_segments.forEach(function(e){var n=o.drawn_reactions[e.reaction_id].segments[e.segment_id];i.push(n.from_node_id==t?n.to_node_id:n.from_node_id)}),i.forEach(function(e){var n=[];o.drawn_nodes[e].connected_segments.forEach(function(n){var i=o.drawn_reactions[n.reaction_id].segments[n.segment_id],s=i.from_node_id==e?i.to_node_id:i.from_node_id,u=o.drawn_nodes[s];u.node_type=="metabolite"&&s!=t&&(u.node_is_primary=!1,r.push(s))})}),draw_these_nodes(r)}function g(){var e=get_selected_nodes(),t=Object.keys(e)[0],n=e[t],r=[],i;o.drawn_nodes[t].connected_segments.forEach(function(e){i=[e.reaction_id];var n=o.drawn_reactions[e.reaction_id].segments[e.segment_id];r.push(n.from_node_id==t?n.to_node_id:n.from_node_id)});if(r.length!=1)return console.error("Only connected nodes with a single reaction can be selected");var s=r[0],u=[t],a=[];o.drawn_nodes[s].connected_segments.forEach(function(e){var n=o.drawn_reactions[e.reaction_id].segments[e.segment_id],r=n.from_node_id==s?n.to_node_id:n.from_node_id,i=o.drawn_nodes[r];i.node_type=="metabolite"&&r!=t&&u.push(String(r))});for(var f=0;f<u.length;f++)if(o.drawn_nodes[u[f]].connected_segments.length>1)return console.error("Only connected nodes with a single reaction can be selected");for(var l in e)if(l!=t&&u.indexOf(l)==-1)return console.warn("Selected nodes are not on the same reaction");var c=[],h=u.length-1,p=o.drawn_nodes[u[h]],d=p.node_is_primary,v={x:p.x,y:p.y,label_x:p.label_x,label_y:p.label_y},m=p.connected_segments[0],g=o.drawn_reactions[m.reaction_id].segments[m.segment_id],y={b1:g.b1,b2:g.b2},b;u.forEach(function(e){var t=o.drawn_nodes[e],n=t.node_is_primary,r={x:t.x,y:t.y,label_x:t.label_x,label_y:t.label_y},i=t.connected_segments[0],s=o.drawn_reactions[i.reaction_id].segments[i.segment_id],u={b1:s.b1,b2:s.b2};t.node_is_primary=d,t.x=v.x,t.y=v.y,t.label_x=v.label_x,t.label_y=v.label_y,s.b1=y.b1,s.b2=y.b2,d=n,v=r,y=u,t.node_is_primary&&(b=e),c.push(e)});var w=o.drawn_nodes[s].connected_segments,h=w.length-1,E=[w[h]];w.forEach(function(e,t){if(h==t)return;E.push(e)}),o.drawn_nodes[s].connected_segments=E,draw_these_nodes(c),draw_these_reactions(i),select_metabolite_with_id(b)}function y(){o.direction_arrow.set_rotation(0)}function b(){o.direction_arrow.set_rotation(90)}function w(){o.direction_arrow.set_rotation(180)}function E(){o.direction_arrow.set_rotation(270)}function S(){o.undo_stack.undo()}function x(){o.undo_stack.redo()}var n=e.make_class();return n.prototype={init:r},n}),n("builder/CobraModel",["vis/utils"],function(e){function n(e,t){this.reactions=e,this.cofactors=t}var t=e.make_class();return t.prototype={init:n},t}),n("builder/Brush",["vis/utils","lib/d3"],function(e,t){function r(e,t,n){this.brush_sel=e.append("g").attr("id","brush-container"),this.enabled=t,this.map=n}function i(){return t.select(".brush").empty()}function s(){this.enable_brush(!0)}function o(){this.enable_brush(!1)}function u(e){function n(e,n,r,i){var s=[];n.each(function(e){s.push(e.node_id)});var o=t.svg.brush().x(t.scale.identity().domain([0,r])).y(t.scale.identity().domain([0,i])).on("brush",function(){var e=t.event.target.extent();n.classed("selected",function(t){var n=this.map.scale.x(t.x),r=this.map.scale.y(t.y);return e[0][0]<=n&&n<e[1][0]&&e[0][1]<=r&&r<e[1][1]})}).on("brushend",function(){t.event.target.clear(),t.select(this).call(t.event.target)}),u=e.append("g").attr("class","brush").call(o);return u}e===undefined&&(e=!this.enabled),e?this.selection_brush=n(this.brush_sel,t.select("#nodes").selectAll(".node"),width,height):this.brush_sel.selectAll(".brush").remove()}var n=e.make_class();return n.prototype={init:r,on:s,off:o,toggle:u},n}),n("builder/Builder",["vis/utils","lib/d3","builder/Input","builder/ZoomContainer","builder/Map","builder/KeyManager","builder/CobraModel","builder/Brush"],function(e,t,n,r,i,s,o,u){function f(n){function s(e,t){e&&console.warn(e),this.o.map_data=t}function o(e,t){e&&console.warn(e),this.o.cobra_model=t}function u(e,t){e&&console.warn(e),this.o.css=t}function a(e,t,n){e&&console.warn(e),n==0?this.o.flux=t:n==1&&(this.o.flux2=t)}function f(e,t){e&&console.warn(e),this.o.node_data=t}var r=e.set_options(n,{margins:{top:10,right:10,bottom:10,left:20},selection:t.select("body").append("div"),selection_is_svg:!1,fillScreen:!1,update_hook:!1,map_path:null,map:null,cobra_model_path:null,cobra_model:null,css_path:null,css:null,flux_path:null,flux:null,flux2_path:null,flux2:null,node_data:null,node_data_path:null,node_data_style:"ColorSize",node_data_range:[0,100],show_beziers:!1,debug:!1,starting_reaction:"GLCtex",reaction_arrow_displacement:35});if(r.selection_is_svg)return console.error("Builder does not support placement within svg elements"),null;this.o=r;var i=[{file:r.map_path,value:r.map,callback:s},{file:r.cobra_model_path,value:r.cobra_model,callback:o},{file:r.css_path,value:r.css,callback:u},{file:r.flux_path,value:r.flux,callback:function(e,t){a.call(this,e,t,0)}},{file:r.flux2_path,value:r.flux2,callback:function(e,t){a.call(this,e,t,1)}},{file:r.node_data_path,value:r.node_data,callback:f}];e.load_files(this,i,l)}function l(){var f="#505050",l=!0,c=!1,h=null;this.o.cobra_model&&(h=o(this.o.cobra_model.reactions,this.o.cobra_model.cofactors)),e.remove_child_nodes(this.o.selection);var p=e.setup_svg(this.o.selection,this.o.selection_is_svg,this.o.margins,this.o.fill_screen),d=p.svg,v=p.height,m=p.width,g=e.setup_defs(d,this.o.css),y=new r(d,m,v,[.05,15]),b=y.zoomed_sel,w=m,E=v,S,x;this.o.map_data?(x=i.from_data(this.o.map_data,b,g,y,v,m,this.o.flux,this.o.node_data,h),y.reset()):x=new i(b,g,y,v,m,this.o.flux,this.o.node_data,h);var T=n(this.o.selection,x,y),N={x:m,y:v},C=b.append("rect").attr("id","mouse-node").attr("width",N.x).attr("height",N.y).attr("style","stroke:black;fill:none;").attr("pointer-events","all"),k=new u(b,!1,x),L=a.get_keys(x,T,k),A=new s(L,T),O=this._setup_menu(this.o.selection,x,y,A,L),M=this._setup_status(this.o.selection);if(!this.o.map_data){var _={x:this.o.width*5,y:this.o.height*5};x.new_reaction_from_scratch(this.o.starting_reaction,_),x.zoom_extent(200)}else x.draw_everything(),x.zoom_extent(200);t.select("#loading").style("display","none")}function c(){console.error("not implemented")}function h(){console.error("not implemented")}function p(){console.error("not implemented")}function d(t,n,r,i,s){function f(e,t){e&&console.warn(e),this.o.map_data=t,this.reload_builder()}function l(e,t){this.o.flux=t,n.set_flux(t)}function c(e,t){this.o.node_data=t,n.set_node_data(t)}function h(e,t,n,r){var i=e.append("button").attr("class","command-button").text(n).on("click",t);return r!==undefined&&i.attr("id",r),i}function p(t,n,r){var i=t.append("input").attr("class","command-button").attr("type","file").style("display","none").on("change",function(){e.load_json(this.files[0],n)});return h(o,function(e){i.node().click()},r),function(){i.node().click()}}var o=t.append("div").attr("id","menu");h(o,s.toggle_input.fn,"New reaction (/)"),h(o,s.save.fn,"Save (^s)"),h(o,s.save_svg.fn,"Export SVG (^Shift s)"),i.load_input_click_fn=p(o,f,"Load (^o)"),i.load_flux_input_click_fn=p(o,l,"Load flux (^f)"),p(o,c,"Load node data");var u=h(o,s.toggle_beziers.fn,"Hide control points (b)","bezier-button");n.callback_manager.set("toggle_beziers.button",function(e){u.text((e?"Hide":"Show")+" control points (b)")});var a=h(o,s.toggle_zoom.fn,"Enable select (v)","zoom-button");return r.callback_manager.set("toggle_zoom.button",function(e){u.text(e?"Enable select (v)":"Enable pan+zoom (z)")}),h(o,s.rotate.fn,"Rotate (r)"),h(o,s.delete.fn,"Delete (del)"),h(o,s.extent.fn,"Zoom extent (^0)"),h(o,s.make_primary.fn,"Make primary metabolite (p)"),h(o,s.cycle_primary.fn,"Cycle primary metabolite (c)"),h(o,s.direction_arrow_left.fn,"<"),h(o,s.direction_arrow_up.fn,"^"),h(o,s.direction_arrow_down.fn,"v"),h(o,s.direction_arrow_right.fn,">"),h(o,s.undo.fn,"Undo (^z)"),h(o,s.redo.fn,"Redo (^Shift z)"),o}function v(e){return e.append("div").attr("id","status")}function m(e,t,n){return{toggle_input:{key:191,fn:t.toggle},save:{key:83,modifiers:{control:!0},fn:e.save},save_svg:{key:83,modifiers:{control:!0,shift:!0},fn:e.save_svg},load:{key:79,modifiers:{control:!0},fn:null},load_flux:{key:70,modifiers:{control:!0},fn:null},toggle_beziers:{key:66,fn:e.toggle_beziers,ignore_with_input:!0},toggle_zoom:{key:90,fn:this.toggle_zoom,ignore_with_input:!0},brush:{key:86,fn:this.toggle_zoom,ignore_with_input:!0},rotate:{key:82,fn:e.rotate_selected_nodes,ignore_with_input:!0},"delete":{key:8,fn:e.delete_selected_nodes,ignore_with_input:!0},extent:{key:48,modifiers:{control:!0},fn:e.zoom_extent},make_primary:{key:80,fn:e.make_selected_node_primary,ignore_with_input:!0},cycle_primary:{key:67,fn:e.cycle_primary_node,ignore_with_input:!0},direction_arrow_right:{key:39,fn:e.direction_arrow.right,ignore_with_input:!0},direction_arrow_down:{key:40,fn:e.direction_arrow.down,ignore_with_input:!0},direction_arrow_left:{key:37,fn:e.direction_arrow.left,ignore_with_input:!0},direction_arrow_up:{key:38,fn:e.direction_arrow.up,ignore_with_input:!0},undo:{key:90,modifiers:{control:!0},fn:e.undo_stack.undo},redo:{key:90,modifiers:{control:!0,shift:!0},fn:e.undo_stack.redo}}}var a=e.make_class();return a.get_keys=m,a.prototype={init:f,reload_builder:l,reload_for_flux:h,reload_for_node_data:p,_setup_menu:d,_setup_status:v},a}),n("main",["builder/Builder","builder/KeyManager"],function(e,t){return{Builder:e,KeyManager:t}}),t("main")});